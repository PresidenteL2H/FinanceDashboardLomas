<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financiero Mejorado</title>
    <style>
        :root {
            --font-primary: 'Roboto', sans-serif;
            --font-monospace: 'Roboto Mono', monospace;
            --bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-hover: 0 6px 12px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --color-ingresos: #20c997;
            --color-gastos: #dc3545;
            --color-ahorro: #0d6efd;
            --color-tasa-ahorro: #6f42c1;
            --color-balance: #fd7e14;
            --color-transacciones: #6c757d;
            --color-header-bg: #f8f9fa;
            --color-total-bg: #343a40;
            --color-selected: #0d6efd;
            --color-selected-bg: #e7f3ff;
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: var(--font-primary);
            margin: 0;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-primary);
            padding-bottom: 100px; /* Space for the sticky filter bar */
        }

        #financial-dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .db-container {
            background: var(--card-bg-color);
            padding: 24px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .db-container-title {
            margin: 0 0 20px 0;
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Cards */
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--card-bg-color);
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .kpi-card h3 {
            margin: 0 0 12px 0;
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .kpi-card .value {
            font-size: 26px;
            font-weight: 700;
            font-family: var(--font-monospace);
            margin-bottom: 8px;
        }
        
        .kpi-card.ahorro-neto .value.positive { color: var(--color-ingresos); }
        .kpi-card.ahorro-neto .value.negative { color: var(--color-gastos); }
        
        .kpi-card small {
            color: var(--text-secondary);
            font-size: 11px;
            display: block;
            margin-top: 8px;
        }

        .kpi-card.ingresos { border-top: 4px solid var(--color-ingresos); }
        .kpi-card.ingresos .value { color: var(--color-ingresos); }
        .kpi-card.gastos { border-top: 4px solid var(--color-gastos); }
        .kpi-card.gastos .value { color: var(--color-gastos); }
        .kpi-card.ahorro-neto { border-top: 4px solid var(--color-ahorro); }
        .kpi-card.tasa-ahorro { border-top: 4px solid var(--color-tasa-ahorro); }
        .kpi-card.tasa-ahorro .value { color: var(--color-tasa-ahorro); }
        .kpi-card.balance { border-top: 4px solid var(--color-balance); }
        .kpi-card.balance .value { color: var(--color-balance); }
        .kpi-card.transacciones { border-top: 4px solid var(--color-transacciones); }
        .kpi-card.transacciones .value { color: var(--color-transacciones); }

        /* Filters */
        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .filter-select, .filter-input {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card-bg-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-primary);
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--color-balance);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }

        /* Active Filters Panel */
        .active-filters {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            padding: 16px 24px;
            background: var(--card-bg-color);
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%); /* Start off-screen */
        }

        .active-filters.visible {
            transform: translateY(0); /* Slide into view */
        }

        .filter-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: white;
            border: 1px solid var(--color-selected);
            border-radius: 20px;
            font-size: 13px;
            color: var(--color-selected);
            font-weight: 500;
        }

        .filter-badge .remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .filter-badge .remove:hover {
            opacity: 1;
        }

        .clear-all-btn {
            padding: 8px 16px;
            border: 1px solid #e74c3c;
            border-radius: 20px;
            background: #e74c3c;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .clear-all-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        /* Charts */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .chart-grid-double {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        /* Tables */
        .db-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .db-table th, .db-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }

        .db-table thead tr {
            background-color: var(--color-header-bg);
        }

        .db-table th {
            font-weight: 600;
            color: var(--text-primary);
            border-bottom-width: 2px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .db-table th:hover {
            background-color: #e9ecef;
        }

        .db-table th.sortable::after {
            content: '⇅';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }

        .db-table th.sorted-asc::after {
            content: '↑';
            opacity: 1;
        }

        .db-table th.sorted-desc::after {
            content: '↓';
            opacity: 1;
        }

        .db-table .text-right { text-align: right; }
        .db-table .text-center { text-align: center; }
        .db-table .color-ingresos { color: var(--color-ingresos); }
        .db-table .color-gastos { color: var(--color-gastos); }
        .db-table .color-per-home { color: var(--color-per-home); }
        .db-table .color-secondary { color: var(--text-secondary); }

        .db-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .db-table tbody tr.interactive-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .db-table tbody tr.selected {
            background-color: var(--color-selected-bg);
            border-left: 3px solid var(--color-selected);
        }

        .db-table tfoot tr {
            background-color: var(--color-total-bg);
            color: white;
            font-weight: 600;
        }

        .db-table tfoot td {
            border-top: 2px solid #000;
        }

        /* Search and Actions Bar */
        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-balance);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
        }

        .search-box::after {
            content: '🔍';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
        }

        .action-btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: white;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .action-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            padding: 16px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--color-balance);
            color: white;
            border-color: var(--color-balance);
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination .page-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Loading & Error */
        #loading {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
            font-size: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        #error {
            display: none;
            background: #fff5f5;
            color: #c53030;
            padding: 16px 20px;
            border-radius: 4px;
            text-align: center;
            margin-top: 20px;
            border: 1px solid #fed7d7;
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .chart-grid-double {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .kpi-cards {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .filters-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            body {
                padding: 10px;
                padding-bottom: 120px; /* More space on mobile */
            }
            
            .kpi-cards {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="financial-dashboard">
        <!-- Filtros -->
        <div class="db-container">
            <h3 class="db-container-title">🔍 Filtros</h3>
            <div class="filters-container">
                <div class="filter-group">
                    <label for="filter-select">Período rápido:</label>
                    <select id="filter-select" class="filter-select">
                        <option value="all">Todos los datos</option>
                        <option value="current_month">Mes actual</option>
                        <option value="current_year" selected>Año actual</option>
                        <option value="last_3_months">Últimos 3 meses</option>
                        <option value="last_6_months">Últimos 6 meses</option>
                        <option value="last_12_months">Últimos 12 meses</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="start-date-select">Fecha desde:</label>
                    <input type="month" id="start-date-select" class="filter-input">
                </div>

                <div class="filter-group">
                    <label for="end-date-select">Fecha hasta:</label>
                    <input type="month" id="end-date-select" class="filter-input">
                </div>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-cards">
            <div class="kpi-card ingresos">
                <h3>Total Ingresos</h3>
                <div id="total-ingresos" class="value">€0,00</div>
                <small>Suma de ingresos</small>
            </div>
            <div class="kpi-card gastos">
                <h3>Total Gastos</h3>
                <div id="total-gastos" class="value">€0,00</div>
                <small>Suma de gastos</small>
            </div>
            <div class="kpi-card ahorro-neto">
                <h3>Ahorro Neto</h3>
                <div id="ahorro-neto" class="value">€0,00</div>
                <small>Ingresos - Gastos</small>
            </div>
             <div class="kpi-card tasa-ahorro">
                <h3>Tasa de Ahorro</h3>
                <div id="tasa-ahorro" class="value">0.0%</div>
                <small>(Ahorro / Ingresos)</small>
            </div>
            <div class="kpi-card balance">
                <h3>Balance Actual</h3>
                <div id="saldo-final" class="value">€0,00</div>
                <small>Saldo más reciente</small>
            </div>
            <div class="kpi-card transacciones">
                <h3>Transacciones</h3>
                <div id="total-transacciones" class="value">0</div>
                <small>Registros filtrados</small>
            </div>
        </div>

        <!-- Charts -->
        <div class="chart-grid">
            <div class="db-container">
                <h3 class="db-container-title">
                    📈 Evolución Mensual
                    <small style="font-size: 11px; font-weight: normal; opacity: 0.7;">(Click en puntos para filtrar por mes)</small>
                </h3>
                <div class="chart-wrapper">
                    <canvas id="monthly-flow-chart"></canvas>
                </div>
            </div>
            
            <div class="chart-grid-double">
                <div class="db-container">
                    <h3 class="db-container-title">
                        📊 Gastos por Categoría 
                        <small style="font-size: 11px; font-weight: normal; opacity: 0.7;">(Click para filtrar)</small>
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="expenses-chart"></canvas>
                    </div>
                </div>
                
                <div class="db-container">
                    <h3 class="db-container-title">
                        💰 Ahorro Neto Mensual
                        <small style="font-size: 11px; font-weight: normal; opacity: 0.7;">(Ingresos - Gastos)</small>
                    </h3>
                    <div class="chart-wrapper">
                        <canvas id="net-savings-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Summary Table -->
        <div class="db-container">
            <h3 class="db-container-title">📋 Resumen por Categorías</h3>
            <div style="overflow-x: auto;">
                <div id="category-summary-table"></div>
            </div>
        </div>

        <!-- All Transactions -->
        <div class="db-container">
            <h3 class="db-container-title">💳 Todas las Transacciones</h3>
            
            <div class="actions-bar">
                <div class="search-box">
                    <input type="text" id="transaction-search" placeholder="Buscar por concepto...">
                </div>
                <button class="action-btn" onclick="window.exportToCSV()">
                    📥 Exportar CSV
                </button>
            </div>
            
            <div id="all-transactions-table" style="max-height: 600px; overflow-y: auto;"></div>
            
            <div id="pagination" class="pagination"></div>
        </div>

        <div id="loading">
            Cargando datos financieros... ⏳
        </div>
        <div id="error"></div>

        <!-- Active Filters Panel -->
        <div id="active-filters" class="active-filters">
            <strong style="font-size: 13px;">Filtros activos:</strong>
            <div id="filter-badges" style="flex-grow: 1; display: flex; flex-wrap: wrap; gap: 8px;"></div>
            <button class="clear-all-btn" onclick="window.clearAllFilters()">
                ✕ Limpiar todos
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function() {
            'use strict';
            
            const TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRbRz_jPWvTjSM4jmrlUdShW9JzuNagS1LaSQ43rUupeA4e6XbdEqg-UupxL7mn5lNwGftn_8FDPikX/pub?gid=1981585980&single=true&output=tsv';
            
            let financialData = [];
            let currentFilter = 'current_year';
            let selectedCategories = new Set();
            let selectedMonths = new Set();
            let startDate = null;
            let endDate = null;
            let searchQuery = '';
            let currentPage = 1;
            let itemsPerPage = 50;
            let sortColumn = 'F. Operativa';
            let sortDirection = 'desc';

            function hexToRgba(hex, alpha = 1) {
                const bigint = parseInt(hex.slice(1), 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }

            const chartColors = {};

            function parseTSV(tsvText) {
                const lines = tsvText.split('\n');
                const headers = lines[0].split('\t');
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split('\t');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index] ? values[index].trim() : '';
                        });
                        data.push(row);
                    }
                }
                return data;
            }
            
            function parseAmount(amountStr) {
                if (!amountStr || amountStr === '') return 0;
                let cleanStr = amountStr.replace(/€/g, '').replace(/"/g, '').trim();
                if (!cleanStr) return 0;
                if (cleanStr.includes('.') && cleanStr.includes(',')) {
                    cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
                } else if (cleanStr.includes(',') && !cleanStr.includes('.')) {
                    cleanStr = cleanStr.replace(',', '.');
                }
                const result = parseFloat(cleanStr);
                return isNaN(result) ? 0 : result;
            }
            
            function formatCurrency(amount) {
                return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(amount);
            }
            
            function parseDate(dateStr) {
                if (!dateStr) return null;
                let date;
                if (dateStr.includes('/')) {
                    const parts = dateStr.split('/');
                    date = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    date = new Date(dateStr);
                }
                return !isNaN(date.getTime()) ? date : null;
            }

            function getFilteredData() {
                let data = financialData;
                const isDateRangeActive = startDate || endDate;
                document.getElementById('filter-select').disabled = isDateRangeActive;

                if (isDateRangeActive) {
                    data = data.filter(item => {
                        const itemDate = parseDate(item['F. Operativa']);
                        if (!itemDate) return false;
                        const startCheck = !startDate || itemDate >= startDate;
                        const endCheck = !endDate || itemDate <= endDate;
                        return startCheck && endCheck;
                    });
                } else if (currentFilter !== 'all') {
                    const currentDate = new Date();
                    data = data.filter(item => {
                        const itemDate = parseDate(item['F. Operativa']);
                        if (!itemDate) return false;
                        switch (currentFilter) {
                            case 'current_month': return itemDate.getFullYear() === currentDate.getFullYear() && itemDate.getMonth() === currentDate.getMonth();
                            case 'current_year': return itemDate.getFullYear() === currentDate.getFullYear();
                            case 'last_3_months': return itemDate >= new Date(currentDate.getFullYear(), currentDate.getMonth() - 2, 1);
                            case 'last_6_months': return itemDate >= new Date(currentDate.getFullYear(), currentDate.getMonth() - 5, 1);
                            case 'last_12_months': return itemDate >= new Date(currentDate.getFullYear(), currentDate.getMonth() - 11, 1);
                            default: return true;
                        }
                    });
                }
                
                if (selectedCategories.size > 0) {
                    data = data.filter(item => selectedCategories.has(item.Categoria || 'Sin categoría'));
                }
                
                if (selectedMonths.size > 0) {
                    data = data.filter(item => {
                        const itemDate = parseDate(item['F. Operativa']);
                        if (!itemDate) return false;
                        const itemMonthKey = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`;
                        return selectedMonths.has(itemMonthKey);
                    });
                }
                return data;
            }

            function calculateSummary(data) {
                const summary = { totalIngresos: 0, totalGastos: 0, ahorroNeto: 0, tasaAhorro: 0, saldoFinal: 0, transacciones: data.length };
                data.forEach(item => {
                    summary.totalGastos += parseAmount(item.Gastos || '0');
                    summary.totalIngresos += parseAmount(item.Ingresos || '0');
                });
                summary.ahorroNeto = summary.totalIngresos - summary.totalGastos;
                summary.tasaAhorro = summary.totalIngresos > 0 ? (summary.ahorroNeto / summary.totalIngresos) * 100 : 0;
                if (financialData.length > 0) {
                    summary.saldoFinal = parseAmount(financialData[0]['Saldo'] || '0');
                }
                return summary;
            }
            
            function getExpensesByCategory(data) {
                const categories = {};
                data.forEach(item => {
                    const gastos = parseAmount(item.Gastos || '0');
                    if (gastos > 0) {
                        const category = item.Categoria || 'Sin categoría';
                        categories[category] = (categories[category] || 0) + gastos;
                    }
                });
                return Object.entries(categories).sort(([, a], [, b]) => b - a).slice(0, 10);
            }
            
            function getMonthlyFlow(data) {
                const monthlyData = {};
                const dataSortedAsc = [...data].sort((a,b) => parseDate(a['F. Operativa']) - parseDate(b['F. Operativa']));

                dataSortedAsc.forEach(item => {
                    const date = parseDate(item['F. Operativa']);
                    if (!date) return;
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { ingresos: 0, gastos: 0, balances: [], endBalance: 0 };
                    }
                    monthlyData[monthKey].gastos += parseAmount(item.Gastos || '0');
                    monthlyData[monthKey].ingresos += parseAmount(item.Ingresos || '0');
                    monthlyData[monthKey].balances.push(parseAmount(item['Saldo'] || '0'));
                    monthlyData[monthKey].endBalance = parseAmount(item['Saldo'] || '0');
                });
                
                Object.keys(monthlyData).forEach(key => {
                    monthlyData[key].minBalance = monthlyData[key].balances.length > 0 ? Math.min(...monthlyData[key].balances) : 0;
                    delete monthlyData[key].balances;
                });
                
                return Object.entries(monthlyData).sort(([a], [b]) => a.localeCompare(b));
            }

            function createBarChart(canvasId, data) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(([label]) => label.length > 15 ? label.substring(0, 15) + '...' : label),
                        datasets: [{
                            label: 'Gastos (€)',
                            data: data.map(([, value]) => value),
                            backgroundColor: data.map(([label]) => selectedCategories.has(label) ? hexToRgba(chartColors.balance, 0.8) : 'rgba(52, 73, 94, 0.8)'),
                            borderColor: data.map(([label]) => selectedCategories.has(label) ? chartColors.balance : 'rgba(52, 73, 94, 1)'),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        onClick: (e, el) => { if (el.length > 0) window.toggleCategory(data[el[0].index][0]); },
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { title: c => data[c[0].dataIndex][0], label: c => 'Gastos: ' + formatCurrency(c.parsed.y) } }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#7f8c8d', maxRotation: 45, minRotation: 0 } },
                            y: { beginAtZero: true, grid: { color: 'rgba(127, 140, 141, 0.2)' }, ticks: { color: '#7f8c8d', callback: v => formatCurrency(v) } }
                        }
                    }
                });
            }

            function createLineChart(canvasId, data) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const last12MonthsData = data.slice(-12);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last12MonthsData.map(([m]) => m.substring(5, 7) + '/' + m.substring(0, 4)),
                        datasets: [
                            { label: 'Ingresos', data: last12MonthsData.map(([, v]) => v.ingresos), borderColor: chartColors.ingresos, backgroundColor: hexToRgba(chartColors.ingresos, 0.1), tension: 0.3, borderWidth: 2 },
                            { label: 'Gastos', data: last12MonthsData.map(([, v]) => v.gastos), borderColor: chartColors.gastos, backgroundColor: hexToRgba(chartColors.gastos, 0.1), tension: 0.3, borderWidth: 2 },
                            { label: 'Saldo Final', data: last12MonthsData.map(([, v]) => v.endBalance), borderColor: chartColors.balance, backgroundColor: hexToRgba(chartColors.balance, 0.1), tension: 0.3, borderWidth: 3, yAxisID: 'y1' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        onClick: (e, el) => { if (el.length > 0) window.toggleMonth(last12MonthsData[el[0].index][0]); },
                        plugins: { legend: { labels: { color: '#2c3e50', font: { size: 12 } } }, tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.parsed.y)}` } } },
                        scales: {
                            x: { grid: { color: 'rgba(127, 140, 141, 0.2)' }, ticks: { color: '#7f8c8d' } },
                            y: { type: 'linear', display: true, position: 'left', beginAtZero: true, grid: { color: 'rgba(127, 140, 141, 0.2)' }, ticks: { color: '#7f8c8d', callback: v => formatCurrency(v) }, title: { display: true, text: 'Ingresos / Gastos (€)', color: '#2c3e50' } },
                            y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { color: chartColors.balance, callback: v => formatCurrency(v) }, title: { display: true, text: 'Balance (€)', color: chartColors.balance } }
                        }
                    }
                });
            }

            function createNetSavingsChart(canvasId, data) {
                const ctx = document.getElementById(canvasId).getContext('2d');
                const last12MonthsData = data.slice(-12);
                const netSavings = last12MonthsData.map(([, v]) => v.ingresos - v.gastos);
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: last12MonthsData.map(([m]) => m.substring(5, 7) + '/' + m.substring(0, 4)),
                        datasets: [{
                            label: 'Ahorro Neto (€)',
                            data: netSavings,
                            backgroundColor: netSavings.map(v => v >= 0 ? hexToRgba(chartColors.ingresos, 0.8) : hexToRgba(chartColors.gastos, 0.8)),
                            borderColor: netSavings.map(v => v >= 0 ? chartColors.ingresos : chartColors.gastos),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => 'Ahorro: ' + formatCurrency(c.parsed.y) } } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#7f8c8d' } },
                            y: { grid: { color: 'rgba(127, 140, 141, 0.2)' }, ticks: { color: '#7f8c8d', callback: v => formatCurrency(v) } }
                        }
                    }
                });
            }

            function createCategorySummaryTable(data) {
                const container = document.getElementById('category-summary-table');
                const stats = {};
                data.forEach(item => {
                    const cat = item.Categoria || 'Sin categoría';
                    if (!stats[cat]) stats[cat] = { count: 0, total: 0 };
                    stats[cat].count++;
                    stats[cat].total += parseAmount(item.Gastos || '0');
                });
                const sorted = Object.entries(stats).sort(([, a], [, b]) => b.total - a.total);
                const totalGastos = sorted.reduce((sum, [, s]) => sum + s.total, 0);
                let html = `<table class="db-table"><thead><tr><th>Categoría</th><th class="text-center"># Trans.</th><th class="text-right">Suma Gastos</th><th class="text-right">% del Total</th></tr></thead><tbody>`;
                sorted.forEach(([cat, s]) => {
                    const perc = totalGastos > 0 ? (s.total / totalGastos * 100).toFixed(1) : '0.0';
                    html += `<tr class="interactive-row ${selectedCategories.has(cat) ? 'selected' : ''}" onclick="window.toggleCategory('${cat.replace(/'/g, "\\'")}')">
                        <td style="font-weight: 500;">${cat}</td>
                        <td class="text-center">${s.count}</td>
                        <td class="text-right color-gastos" style="font-weight: 500;">${formatCurrency(s.total)}</td>
                        <td class="text-right color-secondary">${perc}%</td>
                    </tr>`;
                });
                html += `</tbody><tfoot><tr><td>TOTAL</td><td class="text-center">${data.length}</td><td class="text-right">${formatCurrency(totalGastos)}</td><td class="text-right">100.0%</td></tr></tfoot></table>`;
                container.innerHTML = html;
            }

            function createAllTransactionsTable(data) {
                const container = document.getElementById('all-transactions-table');
                let filtered = searchQuery ? data.filter(item => (item.Concepto || '').toLowerCase().includes(searchQuery.toLowerCase())) : data;
                if (sortColumn) {
                    filtered.sort((a, b) => {
                        let valA, valB;
                        if (sortColumn === 'F. Operativa') {
                            valA = parseDate(a[sortColumn])?.getTime() || 0;
                            valB = parseDate(b[sortColumn])?.getTime() || 0;
                        } else if (['Importe', 'Gastos', 'Ingresos'].includes(sortColumn)) {
                            valA = parseAmount(a[sortColumn]);
                            valB = parseAmount(b[sortColumn]);
                        } else {
                            valA = (a[sortColumn] || '').toLowerCase();
                            valB = (b[sortColumn] || '').toLowerCase();
                        }
                        return sortDirection === 'asc' ? valA - valB : valB - valA;
                    });
                }
                const totalPages = Math.ceil(filtered.length / itemsPerPage);
                const pageData = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                let html = '<table class="db-table"><thead><tr>';
                const cols = [ { k: 'Tipo', l: 'Tipo' }, { k: 'F. Operativa', l: 'Fecha' }, { k: 'Concepto', l: 'Concepto' }, { k: 'Importe', l: 'Importe', a: 'right' }, { k: 'Categoria', l: 'Categoría' }, { k: 'Gastos', l: 'Gasto', a: 'right' }, { k: 'Ingresos', l: 'Ingreso', a: 'right' } ];
                cols.forEach(c => {
                    const sortClass = sortColumn === c.k ? (sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc') : 'sortable';
                    html += `<th class="${sortClass} ${c.a ? 'text-'+c.a : ''}" onclick="window.sortTable('${c.k}')">${c.l}</th>`;
                });
                html += '</tr></thead><tbody>';
                pageData.forEach(item => {
                    html += `<tr>
                        <td>${item.Tipo || ''}</td>
                        <td>${parseDate(item['F. Operativa'])?.toLocaleDateString('es-ES') || ''}</td>
                        <td>${item.Concepto || ''}</td>
                        <td class="text-right">${formatCurrency(parseAmount(item.Importe))}</td>
                        <td>${item.Categoria || ''}</td>
                        <td class="text-right color-gastos">${formatCurrency(parseAmount(item.Gastos))}</td>
                        <td class="text-right color-ingresos">${formatCurrency(parseAmount(item.Ingresos))}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
                updatePagination(totalPages, filtered.length);
            }

            function updatePagination(totalPages, totalItems) {
                const pag = document.getElementById('pagination');
                if (totalPages <= 1) { pag.innerHTML = ''; return; }
                pag.innerHTML = `<button onclick="window.changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>««</button>
                    <button onclick="window.changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹</button>
                    <span class="page-info">Página ${currentPage} de ${totalPages} (${totalItems} registros)</span>
                    <button onclick="window.changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>›</button>
                    <button onclick="window.changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>»»</button>`;
            }
            
            function updateActiveFiltersPanel() {
                const panel = document.getElementById('active-filters');
                const badges = document.getElementById('filter-badges');
                const hasFilters = selectedCategories.size > 0 || selectedMonths.size > 0 || startDate || endDate || (currentFilter !== 'current_year' && !isDateRangeActive());
                if (!hasFilters) { panel.classList.remove('visible'); return; }
                panel.classList.add('visible');
                let html = '';
                if (currentFilter !== 'current_year' && !isDateRangeActive()) {
                    const names = { 'current_month': 'Mes actual', 'last_3_months': 'Últimos 3 meses', 'last_6_months': 'Últimos 6 meses', 'last_12_months': 'Últimos 12 meses', 'all': 'Todos los datos' };
                    if (names[currentFilter]) html += `<span class="filter-badge">📅 ${names[currentFilter]}</span>`;
                }
                if (isDateRangeActive()) {
                    const start = startDate ? startDate.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' }) : '...';
                    const end = endDate ? endDate.toLocaleDateString('es-ES', { year: 'numeric', month: 'short' }) : '...';
                    html += `<span class="filter-badge">📆 ${start} - ${end} <span class="remove" onclick="window.clearDateRange()">✕</span></span>`;
                }
                selectedCategories.forEach(c => { html += `<span class="filter-badge">🏷️ ${c} <span class="remove" onclick="window.toggleCategory('${c.replace(/'/g, "\\'")}')">✕</span></span>`; });
                selectedMonths.forEach(m => {
                    const [y, n] = m.split('-');
                    const name = new Date(y, n - 1).toLocaleString('es-ES', { month: 'short' });
                    html += `<span class="filter-badge">📊 ${name} ${y} <span class="remove" onclick="window.toggleMonth('${m}')">✕</span></span>`;
                });
                badges.innerHTML = html;
                function isDateRangeActive() { return startDate || endDate; }
            }

            function updateUI() {
                const data = getFilteredData();
                const summary = calculateSummary(data);
                
                document.getElementById('total-ingresos').textContent = formatCurrency(summary.totalIngresos);
                document.getElementById('total-gastos').textContent = formatCurrency(summary.totalGastos);
                const ahorroNetoEl = document.getElementById('ahorro-neto');
                ahorroNetoEl.textContent = formatCurrency(summary.ahorroNeto);
                ahorroNetoEl.className = `value ${summary.ahorroNeto >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('tasa-ahorro').textContent = summary.tasaAhorro.toFixed(1) + '%';
                document.getElementById('saldo-final').textContent = formatCurrency(summary.saldoFinal);
                document.getElementById('total-transacciones').textContent = summary.transacciones;

                updateActiveFiltersPanel();
                Chart.helpers.each(Chart.instances, i => i.destroy());
                
                const expensesByCategory = getExpensesByCategory(data);
                const monthlyFlow = getMonthlyFlow(data);
                
                if (expensesByCategory.length > 0) {
                    createBarChart('expenses-chart', expensesByCategory);
                }
                // We are replacing the doughnut chart, so we remove the call to it.
                // if (expensesByCategory.length > 0) { createDoughnutChart('expenses-doughnut', expensesByCategory); }

                if (monthlyFlow.length > 0) {
                    createLineChart('monthly-flow-chart', monthlyFlow);
                    createNetSavingsChart('net-savings-chart', monthlyFlow);
                }

                createCategorySummaryTable(data);
                currentPage = 1;
                createAllTransactionsTable(data);
            }

            async function loadData() {
                try {
                    document.getElementById('loading').style.display = 'block';
                    const styles = getComputedStyle(document.documentElement);
                    chartColors.ingresos = styles.getPropertyValue('--color-ingresos').trim();
                    chartColors.gastos = styles.getPropertyValue('--color-gastos').trim();
                    chartColors.balance = styles.getPropertyValue('--color-balance').trim();
                    
                    const response = await fetch(TSV_URL);
                    if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                    const tsvText = await response.text();
                    financialData = parseTSV(tsvText);
                    if (financialData.length === 0) throw new Error('No se encontraron datos');
                    
                    document.getElementById('loading').style.display = 'none';
                    updateUI();
                } catch (error) {
                    console.error('Error:', error);
                    const errorEl = document.getElementById('error');
                    errorEl.style.display = 'block';
                    errorEl.textContent = `Error al cargar los datos: ${error.message}. Por favor, verifica la URL y la conexión.`;
                    document.getElementById('loading').style.display = 'none';
                }
            }
            
            window.toggleCategory = c => { selectedCategories.has(c) ? selectedCategories.delete(c) : selectedCategories.add(c); updateUI(); };
            window.toggleMonth = m => { selectedMonths.has(m) ? selectedMonths.delete(m) : selectedMonths.add(m); updateUI(); };
            window.clearDateRange = () => { startDate = null; endDate = null; document.getElementById('start-date-select').value = ''; document.getElementById('end-date-select').value = ''; document.getElementById('filter-select').disabled = false; updateUI(); };
            window.clearAllFilters = () => { selectedCategories.clear(); selectedMonths.clear(); startDate = null; endDate = null; currentFilter = 'current_year'; searchQuery = ''; ['filter-select', 'start-date-select', 'end-date-select', 'transaction-search'].forEach(id => document.getElementById(id).value = id === 'filter-select' ? 'current_year' : ''); document.getElementById('filter-select').disabled = false; updateUI(); };
            window.sortTable = c => { if (sortColumn === c) { sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'; } else { sortColumn = c; sortDirection = 'asc'; } createAllTransactionsTable(getFilteredData()); };
            window.changePage = p => { currentPage = p; createAllTransactionsTable(getFilteredData()); };
            window.exportToCSV = () => { const data = getFilteredData(); if(data.length === 0) return; const headers = Object.keys(data[0]); const csv = [headers.join(','), ...data.map(row => headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(','))].join('\n'); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'export.csv'; a.click(); URL.revokeObjectURL(url); };

            document.getElementById('filter-select').addEventListener('change', function() { currentFilter = this.value; updateUI(); });
            document.getElementById('start-date-select').addEventListener('change', function() { startDate = this.value ? new Date(this.value + '-01T00:00:00Z') : null; updateUI(); });
            document.getElementById('end-date-select').addEventListener('change', function() { if (this.value) { const [y, m] = this.value.split('-'); endDate = new Date(Date.UTC(y, m, 0, 23, 59, 59, 999)); } else { endDate = null; } updateUI(); });
            document.getElementById('transaction-search').addEventListener('input', function() { searchQuery = this.value; currentPage = 1; createAllTransactionsTable(getFilteredData()); });

            loadData();
        })();
    </script>
</body>
</html>

